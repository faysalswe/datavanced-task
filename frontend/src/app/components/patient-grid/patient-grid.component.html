<div class="patient-container">
  <h1>Patient Management</h1>

  <!-- Search and Add Section -->
  <div class="toolbar">
    <div class="search-box">
      <input 
        type="text" 
        [(ngModel)]="keyword" 
        (keyup.enter)="search()"
        placeholder="Search patients..."
        class="search-input"
      />
      <button (click)="search()" class="btn btn-primary">Search</button>
    </div>
    <button (click)="toggleAddForm()" class="btn btn-success">
      {{ showAddForm ? 'Cancel' : 'Add Patient' }}
    </button>
  </div>

  <!-- Add Patient Form -->
  <div *ngIf="showAddForm" class="add-form">
    <h2>Add New Patient</h2>
    <div class="form-grid">
      <div class="form-group">
        <label>First Name:</label>
        <input type="text" [(ngModel)]="newPatient.firstName" class="form-input" />
      </div>
      <div class="form-group">
        <label>Last Name:</label>
        <input type="text" [(ngModel)]="newPatient.lastName" class="form-input" />
      </div>
      <div class="form-group">
        <label>Date of Birth:</label>
        <input type="date" [(ngModel)]="newPatient.dateOfBirth" class="form-input" />
      </div>
      <div class="form-group">
        <label>Phone:</label>
        <input type="text" [(ngModel)]="newPatient.phone" class="form-input" />
      </div>
      <div class="form-group">
        <label>Email:</label>
        <input type="email" [(ngModel)]="newPatient.email" class="form-input" />
      </div>
      <div class="form-group">
        <label>Address:</label>
        <input type="text" [(ngModel)]="newPatient.address" class="form-input" />
      </div>
    </div>
    
    <div class="form-group">
      <label>Assign Caregivers:</label>
      <div class="caregiver-list">
        <label *ngFor="let caregiver of availableCaregivers" class="checkbox-label">
          <input 
            type="checkbox" 
            [checked]="isNewPatientCaregiverSelected(caregiver.id)"
            (change)="toggleNewPatientCaregiver(caregiver.id)"
          />
          {{ caregiver.firstName }} {{ caregiver.lastName }} ({{ caregiver.specialization }})
        </label>
      </div>
    </div>
    
    <button (click)="addPatient()" class="btn btn-primary">Save Patient</button>
  </div>

  <!-- Patient Grid -->
  <div class="grid-container">
    <table class="patient-table">
      <thead>
        <tr>
          <th (click)="sort('firstName')" class="sortable">
            First Name {{ sortBy === 'firstName' ? (isDescending ? '▼' : '▲') : '' }}
          </th>
          <th (click)="sort('lastName')" class="sortable">
            Last Name {{ sortBy === 'lastName' ? (isDescending ? '▼' : '▲') : '' }}
          </th>
          <th (click)="sort('dateOfBirth')" class="sortable">
            Date of Birth {{ sortBy === 'dateOfBirth' ? (isDescending ? '▼' : '▲') : '' }}
          </th>
          <th>Phone</th>
          <th>Email</th>
          <th>Address</th>
          <th>Caregivers</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let patient of patients">
          <!-- Normal Row -->
          <tr *ngIf="!isEditingPatient(patient)" class="patient-row">
            <td>{{ patient.firstName }}</td>
            <td>{{ patient.lastName }}</td>
            <td>{{ patient.dateOfBirth | date:'shortDate' }}</td>
            <td>{{ patient.phone }}</td>
            <td>{{ patient.email }}</td>
            <td>{{ patient.address }}</td>
            <td>
              <div class="caregiver-tags">
                <span *ngFor="let caregiver of patient.caregivers" class="caregiver-tag">
                  {{ caregiver.firstName }} {{ caregiver.lastName }}
                </span>
                <span *ngIf="patient.caregivers.length === 0" class="no-caregivers">
                  No caregivers assigned
                </span>
              </div>
            </td>
            <td>
              <button (click)="startEdit(patient)" class="btn btn-sm btn-primary">Edit</button>
              <button (click)="deletePatient(patient.id)" class="btn btn-sm btn-danger">Delete</button>
            </td>
          </tr>

          <!-- Edit Row -->
          <tr *ngIf="isEditingPatient(patient)" class="edit-row">
            <td colspan="8">
              <div class="edit-form">
                <h3>Edit Patient</h3>
                <div class="form-grid">
                  <div class="form-group">
                    <label>First Name:</label>
                    <input type="text" [(ngModel)]="editingPatient!.firstName" class="form-input" />
                  </div>
                  <div class="form-group">
                    <label>Last Name:</label>
                    <input type="text" [(ngModel)]="editingPatient!.lastName" class="form-input" />
                  </div>
                  <div class="form-group">
                    <label>Date of Birth:</label>
                    <input type="date" [(ngModel)]="editingPatient!.dateOfBirth" class="form-input" />
                  </div>
                  <div class="form-group">
                    <label>Phone:</label>
                    <input type="text" [(ngModel)]="editingPatient!.phone" class="form-input" />
                  </div>
                  <div class="form-group">
                    <label>Email:</label>
                    <input type="email" [(ngModel)]="editingPatient!.email" class="form-input" />
                  </div>
                  <div class="form-group">
                    <label>Address:</label>
                    <input type="text" [(ngModel)]="editingPatient!.address" class="form-input" />
                  </div>
                </div>
                
                <div class="form-group">
                  <label>Assign Caregivers:</label>
                  <div class="caregiver-list">
                    <label *ngFor="let caregiver of availableCaregivers" class="checkbox-label">
                      <input 
                        type="checkbox" 
                        [checked]="isCaregiverSelected(editingPatient!.caregivers, caregiver.id)"
                        (change)="toggleCaregiver(editingPatient!.caregivers, caregiver.id)"
                      />
                      {{ caregiver.firstName }} {{ caregiver.lastName }} ({{ caregiver.specialization }})
                    </label>
                  </div>
                </div>

                <div class="form-actions">
                  <button (click)="saveEdit()" class="btn btn-primary">Save</button>
                  <button (click)="cancelEdit()" class="btn btn-secondary">Cancel</button>
                </div>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination">
    <button 
      (click)="previousPage()" 
      [disabled]="currentPage === 1"
      class="btn btn-secondary"
    >
      Previous
    </button>
    <span class="page-info">
      Page {{ currentPage }} of {{ totalPages }} ({{ totalCount }} total)
    </span>
    <button 
      (click)="nextPage()" 
      [disabled]="currentPage >= totalPages"
      class="btn btn-secondary"
    >
      Next
    </button>
  </div>
</div>
